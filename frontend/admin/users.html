<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Người dùng - Admin</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="../assets/css/admin.css" />
    <style>
      /* Modal Overlay */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.3s;
        padding: 20px; /* THÊM padding */
        overflow-y: auto; /* CHO PHÉP SCROLL */
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Modal Content */
      .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: calc(100vh - 40px); /* GIỚI HẠN CHIỀU CAO */
        overflow: hidden; /* BỎ overflow-y: auto ở đây */
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s;
        display: flex;
        flex-direction: column; /* THÊM flexbox */
        margin: auto; /* CENTER THEO CHIỀU DỌC */
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Modal Header */
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-bottom: 2px solid #f0f0f0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        flex-shrink: 0; /* KHÔNG CHO CO LẠI */
      }

      .modal-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
      }

      .btn-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        color: white;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .btn-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
      }

      /* Modal Body */
      .modal-body {
        padding: 30px 25px;
        overflow-y: auto; /* CHO PHÉP SCROLL CHỈ PHẦN NÀY */
        flex: 1; /* CHIẾM HẾT KHÔNG GIAN CÒN LẠI */
      }

      /* Custom Scrollbar */
      .modal-body::-webkit-scrollbar {
        width: 8px;
      }

      .modal-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .modal-body::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
      }

      .modal-body::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      }

      /* Form Group */
      .form-group {
        margin-bottom: 24px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }

      .form-group label i {
        margin-right: 8px;
        color: #667eea;
        width: 20px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
        background: #f9f9f9;
        box-sizing: border-box; /* QUAN TRỌNG */
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group input:read-only {
        background: #f5f5f5;
        color: #666;
        cursor: not-allowed;
      }

      /* Badge trong form */
      .form-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-top: 5px;
      }

      .badge-admin {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
      }

      .badge-customer {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
      }

      /* Modal Footer */
      .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 20px 25px;
        border-top: 2px solid #f0f0f0;
        background: #fafafa;
        border-radius: 0 0 12px 12px;
        flex-shrink: 0; /* KHÔNG CHO CO LẠI */
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn i {
        font-size: 16px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
      }

      .btn-secondary {
        background: #e0e0e0;
        color: #666;
      }

      .btn-secondary:hover {
        background: #d0d0d0;
      }

      /* Info Box cho chế độ View */
      .info-box {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      .info-row {
        display: flex;
        margin-bottom: 15px;
        align-items: center;
      }

      .info-row:last-child {
        margin-bottom: 0;
      }

      .info-label {
        font-weight: 600;
        color: #555;
        width: 140px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0; /* KHÔNG CHO CO LẠI */
      }

      .info-label i {
        color: #667eea;
        width: 20px;
      }

      .info-value {
        color: #333;
        flex: 1;
        word-break: break-word; /* CHO PHÉP XUỐNG DÒNG */
      }

      /* Responsive cho màn hình nhỏ */
      @media (max-width: 768px) {
        .modal-content {
          width: 95%;
          max-height: calc(100vh - 20px);
        }

        .modal-header,
        .modal-body,
        .modal-footer {
          padding: 15px 20px;
        }

        .info-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .info-label {
          width: 100%;
          margin-bottom: 5px;
        }
      }
    </style>
  </head>
  <body class="admin-dashboard">
    <!-- Sidebar giữ nguyên -->
    <aside class="admin-sidebar">
      <div class="admin-sidebar-header">
        <a href="index.html">
          <i class="fas fa-pills"></i>
          <span>Nhà Thuốc GB</span>
        </a>
      </div>
      <ul class="admin-nav">
        <li>
          <a href="index.html"
            ><i class="fas fa-tachometer-alt"></i> Tổng quan</a
          >
        </li>
        <li>
          <a href="products.html"
            ><i class="fas fa-box-open"></i> Quản lý Sản phẩm</a
          >
        </li>
        <li>
          <a href="orders.html"
            ><i class="fas fa-shopping-cart"></i> Quản lý Đơn hàng</a
          >
        </li>
        <li>
          <a href="categories.html"
            ><i class="fas fa-tags"></i> Quản lý Danh mục</a
          >
        </li>
        <li>
          <a href="posts.html"
            ><i class="fas fa-newspaper"></i> Quản lý Bài viết</a
          >
        </li>
        <li>
          <a href="users.html" class="active"
            ><i class="fas fa-users"></i> Quản lý Người dùng</a
          >
        </li>
      </ul>
      <div class="admin-user-info">
        <div class="user-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="user-details">
          <p class="user-name"><strong>Administrator</strong></p>
          <p class="user-email">admin@gmail.com</p>
          <a href="login.html" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Đăng xuất
          </a>
        </div>
      </div>
    </aside>

    <!-- Main content giữ nguyên -->
    <main class="admin-main-content">
      <h1>Quản lý Người dùng</h1>

      <div class="admin-toolbar">
        <div class="search-box">
          <input
            type="text"
            id="search-input"
            placeholder="Tìm kiếm theo tên, email, SĐT..."
          />
          <i class="fas fa-search"></i>
        </div>
        <div class="filter-group">
          <select id="role-filter">
            <option value="all">Tất cả quyền</option>
            <option value="customer">Khách hàng</option>
            <option value="admin">Admin</option>
          </select>
          <select id="status-filter">
            <option value="all">Tất cả trạng thái</option>
            <option value="active">Hoạt động</option>
            <option value="inactive">Vô hiệu hóa</option>
          </select>
        </div>
      </div>

      <div class="admin-table-wrapper">
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Họ và tên</th>
              <th>Email</th>
              <th>SĐT</th>
              <th>Quyền</th>
              <th>Trạng thái</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 30px">
                Đang tải dữ liệu...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <script src="../assets/js/config.js"></script>
    <script>
      async function apiFetch(url, options = {}) {
        options.credentials = "include";
        return fetch(url, options);
      }

      let allUsers = [];

      document.addEventListener("DOMContentLoaded", async () => {
        await loadUsers();
        setupEventListeners();
      });

      function setupEventListeners() {
        const searchInput = document.getElementById("search-input");
        if (searchInput) {
          searchInput.addEventListener("input", (e) =>
            filterUsers(e.target.value)
          );
        }

        const roleFilter = document.getElementById("role-filter");
        if (roleFilter) {
          roleFilter.addEventListener("change", (e) =>
            filterUsersByRole(e.target.value)
          );
        }

        const statusFilter = document.getElementById("status-filter");
        if (statusFilter) {
          statusFilter.addEventListener("change", (e) =>
            filterUsersByStatus(e.target.value)
          );
        }
      }

      async function loadUsers() {
        try {
          const response = await apiFetch(`${API_URL}/users.php`);
          const result = await response.json();

          if (result.status === "success") {
            allUsers = result.data;
            displayUsers(allUsers);
          } else {
            alert("Không thể tải danh sách người dùng");
          }
        } catch (error) {
          console.error("Lỗi:", error);
          alert("Lỗi kết nối server");
        }
      }

      function displayUsers(users) {
        const tbody = document.getElementById("users-tbody");
        if (!tbody) return;

        if (users.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 30px;">Không có người dùng nào</td></tr>`;
          return;
        }

        tbody.innerHTML = users
          .map(
            (user) => `
                <tr>
                    <td>${user.id}</td>
                    <td>${escapeHtml(user.full_name || "---")}</td>
                    <td>${escapeHtml(user.email)}</td>
                    <td>${user.phone || "---"}</td>
                    <td>
                        <span class="badge badge-${
                          user.role === "admin" ? "danger" : "info"
                        }">
                            ${user.role === "admin" ? "Admin" : "Khách hàng"}
                        </span>
                    </td>
                    <td>
                        <span class="status-dot ${
                          user.status == 1 || user.status === "active"
                            ? "active"
                            : "inactive"
                        }"></span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="viewUser(${
                              user.id
                            })" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-edit" onclick="editUser(${
                              user.id
                            })" title="Sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteUser(${
                              user.id
                            })" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      async function viewUser(userId) {
        try {
          const response = await apiFetch(`${API_URL}/users.php?id=${userId}`);
          const result = await response.json();
          if (result.status === "success") {
            showUserModal(result.data, "view");
          }
        } catch (error) {
          console.error("Lỗi:", error);
        }
      }

      async function editUser(userId) {
        try {
          const response = await apiFetch(`${API_URL}/users.php?id=${userId}`);
          const result = await response.json();
          if (result.status === "success") {
            showUserModal(result.data, "edit");
          }
        } catch (error) {
          console.error("Lỗi:", error);
        }
      }

      function showUserModal(user, mode) {
        const isView = mode === "view";

        let modalHTML = `
                <div class="modal-overlay" id="user-modal" onclick="if(event.target===this) closeModal()">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>
                                <i class="fas fa-${
                                  isView ? "user-circle" : "user-edit"
                                }"></i>
                                ${
                                  isView
                                    ? "Thông tin người dùng"
                                    : "Chỉnh sửa người dùng"
                                }
                            </h2>
                            <button class="btn-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
            `;

        if (isView) {
          // Chế độ xem - hiển thị đẹp hơn
          modalHTML += `
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label"><i class="fas fa-id-card"></i> ID:</span>
                            <span class="info-value"><strong>#${
                              user.id
                            }</strong></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label"><i class="fas fa-user"></i> Họ và tên:</span>
                            <span class="info-value">${escapeHtml(
                              user.full_name || "---"
                            )}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label"><i class="fas fa-envelope"></i> Email:</span>
                            <span class="info-value">${escapeHtml(
                              user.email
                            )}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label"><i class="fas fa-phone"></i> Số điện thoại:</span>
                            <span class="info-value">${
                              user.phone || "---"
                            }</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label"><i class="fas fa-shield-alt"></i> Quyền:</span>
                            <span class="info-value">
                                <span class="form-badge ${
                                  user.role === "admin"
                                    ? "badge-admin"
                                    : "badge-customer"
                                }">
                                    ${
                                      user.role === "admin"
                                        ? "Admin"
                                        : "Khách hàng"
                                    }
                                </span>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label"><i class="fas fa-toggle-on"></i> Trạng thái:</span>
                            <span class="info-value">
                                <span class="form-badge ${
                                  user.status == 1 || user.status === "active"
                                    ? "badge-customer"
                                    : "badge-admin"
                                }">
                                    ${
                                      user.status == 1 ||
                                      user.status === "active"
                                        ? "Hoạt động"
                                        : "Vô hiệu hóa"
                                    }
                                </span>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label"><i class="fas fa-calendar"></i> Ngày tạo:</span>
                            <span class="info-value">${new Date(
                              user.created_at
                            ).toLocaleDateString("vi-VN")}</span>
                        </div>
                    </div>
                `;
        } else {
          // Chế độ chỉnh sửa - form
          modalHTML += `
                    <form id="user-form">
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> Họ và tên:</label>
                            <input type="text" name="full_name" value="${escapeHtml(
                              user.full_name || ""
                            )}" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-envelope"></i> Email:</label>
                            <input type="email" value="${escapeHtml(
                              user.email
                            )}" readonly>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-phone"></i> Số điện thoại:</label>
                            <input type="tel" name="phone" value="${
                              user.phone || ""
                            }" placeholder="Nhập số điện thoại">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-shield-alt"></i> Quyền:</label>
                            <select name="role" ${
                              user.id === 1 ? "disabled" : ""
                            }>
                                <option value="customer" ${
                                  user.role === "customer" ? "selected" : ""
                                }>Khách hàng</option>
                                <option value="admin" ${
                                  user.role === "admin" ? "selected" : ""
                                }>Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-toggle-on"></i> Trạng thái:</label>
                            <select name="status">
                                <option value="active" ${
                                  user.status == 1 || user.status === "active"
                                    ? "selected"
                                    : ""
                                }>Hoạt động</option>
                                <option value="inactive" ${
                                  user.status == 0 || user.status === "inactive"
                                    ? "selected"
                                    : ""
                                }>Vô hiệu hóa</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('user-form').dispatchEvent(new Event('submit'))">
                        <i class="fas fa-save"></i> Lưu thay đổi
                    </button>
                </div>
                </div></div>
                `;
        }

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        if (!isView) {
          document
            .getElementById("user-form")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              saveUser(user.id, new FormData(e.target));
            });
        }
      }

      async function saveUser(userId, formData) {
        try {
          const data = {
            id: userId,
            full_name: formData.get("full_name"),
            phone: formData.get("phone"),
            role: formData.get("role"),
            status: formData.get("status"),
          };

          const response = await apiFetch(`${API_URL}/users.php`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();
          if (result.status === "success") {
            alert("✅ Cập nhật thành công!");
            closeModal();
            await loadUsers();
          } else {
            alert("❌ " + result.message);
          }
        } catch (error) {
          console.error("Lỗi:", error);
          alert("❌ Không thể cập nhật");
        }
      }

      async function deleteUser(userId) {
        if (userId === 1) {
          alert("❌ Không thể xóa tài khoản Admin chính!");
          return;
        }
        if (!confirm("⚠️ Bạn có chắc muốn xóa người dùng này?")) return;

        try {
          const response = await apiFetch(`${API_URL}/users.php?id=${userId}`, {
            method: "DELETE",
          });
          const result = await response.json();
          if (result.status === "success") {
            alert("✅ Xóa thành công!");
            await loadUsers();
          } else {
            alert("❌ " + result.message);
          }
        } catch (error) {
          console.error("Lỗi:", error);
          alert("❌ Không thể xóa");
        }
      }

      function closeModal() {
        const modal = document.getElementById("user-modal");
        if (modal) {
          modal.style.opacity = "0";
          setTimeout(() => modal.remove(), 300);
        }
      }

      function filterUsers(searchTerm) {
        const filtered = allUsers.filter(
          (user) =>
            user.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            user.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
            user.phone?.includes(searchTerm)
        );
        displayUsers(filtered);
      }

      function filterUsersByRole(role) {
        displayUsers(
          role === "all" ? allUsers : allUsers.filter((u) => u.role === role)
        );
      }

      function filterUsersByStatus(status) {
        displayUsers(
          status === "all"
            ? allUsers
            : allUsers.filter((u) => u.status === status)
        );
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
